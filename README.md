# Этот репозиторий содержит информацию и тестовые программы для придуманной задачи мониторинга загрузки CPU набора серверов
Ссылка на статью на habr.com:
https://habr.com/post/359284/

В папках karl, alex, nomad1, nomad1.utc, nomad2, nomad3 содержатся примеры программ. В папке generator - генератор логов для проверки.

Для генерации данных можно использовать generate.sh, либо откомпилировать C++ версию:
>g++ generate.cpp -o generate

Генерация обычных данных (1 день, 80 Мб):
>./generate data_norm 1000 2 "2014-10-31 00:00" "2014-11-01 00:00"

Генерация данных wide (31 день, 2.3 Гб):
>./generate data_norm 1000 2 "2014-10-01 00:00" "2014-11-01 00:00"

Генерация данных huge (5 дней, 6 Гб):
>./generate data_huge 10000 4 "2014-10-27 22:00" "2014-10-31 22:00"

## Задача
Представьте себе систему мониторинга, в которой 1000+ серверов по несколько CPU записывают каждую минуту лог нагрузки в отдельный файл на выделенный сервер.
В итоге для 1000 серверов по 2 CPU за один день получается каталог с 1000 логами в текстовом виде по 2880 записей в таком формате:
1414689783 192.168.1.10 0 87
1414689783 192.168.1.11 1 93

Поля в файле означают следующее:
timestamp IP cpu_id usage

Надо сделать CLI программу, которая берет в качестве параметра имя каталога с логами и позволяет посмотреть загрузку конкретного процессора в промежуток времени.
Программа может инициализироваться неограниченное время, но время выполнения каждого запроса должно быть меньше секунды.

Нужно поддерживать следующие команды для запроса:

1. Команда QUERY — сводная статистика по серверу за диапазон времени
Синтаксис: IP cpu_id time_start time_end

*Время задается в виде YYYY-MM-DD HH:MM

Пример:

>QUERY 192.168.1.10 1 2014-10-31 00:00 2014-10-31 00:05
(2014-10-31 00:00, 90%), (2014-10-31 00:01, 89%), (2014-10-31 00:02, 87%), (2014-10-31 00:03, 94%), (2014-10-31 00:04, 88%)

2. Команда LOAD — средняя загрузка выбранного процессора для выбранного сервера
Синтаксис: IP cpu_id time_start time_end

Пример:

>LOAD 192.168.1.10 1 2014-10-31 00:00 2014-10-31 00:05
88%

3. Команда STAT — статистика всех процессоров для выбранного сервера
Синтаксис: IP time_start time_end

Пример:

>STAT 192.168.1.10 2014-10-31 00:00 2014-10-31 00:05
0: 23%
1: 88%

Разрешается использовать любые языки программирования, сторонние утилиты. 

P.S. В изначальном задании подразумевалось, что это интерактивная программа, которая принимает команды с консоли после загрузки. Это не обязательно и программа может быть разбита на раздельные части для загрузки и для выполнения запросов. Т.е. допускается вариант с несколькими скриптами init.sh, query.sh, load.sh и т.д.

## Запросы

### data_norm/valid:
QUERY 10.0.2.23 1 2014-10-31 09:00 2014-10-31 12:00

LOAD 10.0.2.254 0 2014-10-31 13:10 2014-10-31 20:38

STAT 10.0.1.1 2014-10-31 04:21 2014-10-31 08:51


### data_norm/wide:
QUERY 10.0.1.11 0 2014-10-01 09:00 2014-10-31 07:21

LOAD 10.0.2.254 1 2014-10-31 15:55 2014-11-04 10:00

STAT 10.0.1.100 2014-10-31 14:21 2015-01-01 01:01


### data_norm/invalid
QUERY 10.0.2.23 1 2015-10-31 09:00 2015-10-31 12:00

LOAD 10.0.2.254 0 2015-10-31 13:10 2015-10-31 20:38

STAT 10.0.1.1 2015-10-31 04:21 2015-10-31 08:51


### data_wide/valid:
QUERY 10.0.2.33 0 2014-10-30 09:00 2014-10-31 02:00

LOAD 10.0.0.125 1 2014-10-02 14:04 2014-10-04 20:38

STAT 10.0.1.10 2014-10-07 00:00 2014-10-17 23:59


### data_wide/wide:
QUERY 10.0.1.11 1 2014-07-30 09:00 2014-10-01 07:21

LOAD 10.0.0.137 0 2014-10-20 04:12 2015-02-01 00:00

STAT 10.0.3.3 2014-10-20 04:12 2015-02-01 00:00


### data_wide/invalid
QUERY 10.0.0.123 1 2015-10-31 09:00 2015-10-31 12:00

LOAD 10.0.0.154 0 2015-10-31 13:10 2015-10-31 20:38

STAT 10.0.0.1 2015-10-31 04:21 2015-10-31 08:51


### data_huge/valid:
QUERY 10.0.2.33 0 2014-10-30 09:00 2014-10-31 02:00

LOAD 10.0.0.125 1 2014-10-28 14:04 2014-10-30 20:38

STAT 10.0.1.10 2014-10-28 00:00 2014-10-30 23:59


### data_huge/wide:
QUERY 10.0.5.72 0 2014-10-31 09:00 2015-11-03 12:11

LOAD 10.0.0.137 0 2014-10-20 04:12 2015-02-01 00:00

STAT 10.0.3.3 2014-10-20 04:12 2015-02-01 00:00


### data_huge/invalid

QUERY 10.0.1.11 1 2014-07-30 09:00 2014-10-01 07:21

LOAD 10.0.0.154 0 2015-10-31 13:10 2015-10-31 20:38

STAT 10.0.0.1 2015-10-31 04:21 2015-10-31 08:51


## Результаты
| Test              | Karl        |          |          | Alex        |            |            | Nomad1      |          |          | Nomad2      |          |          | Nomad3      |          |          | 
|-------------------|-------------|----------|----------|-------------|------------|------------|-------------|----------|----------|-------------|----------|----------|-------------|----------|----------| 
| data_norm/valid   | 0.008800    | 0.000440 | 0.000420 | 0.215300    | 0.211700   | 0.217800   | 0.256200    | 0.007300 | 0.008300 | 0.002160    | 0.000130 | 0.000140 | 0.050200    | 0.050300 | 0.052600 | 
| data_norm/wide    | 0.002640    | 0.000330 | 0.000630 | 0.218000    | 0.212000   | 0.215000   | 0.716000    | 0.008000 | 0.008600 | 0.005000    | 0.000150 | 0.000320 | 0.050200    | 0.005200 | 0.005500 | 
| data_norm/invalid | 0.000063    | 0.000073 | 0.000065 | 0.214200    | 0.209100   | 0.206300   | 0.007600    | 0.008300 | 0.008100 | 0.000008    | 0.000026 | 0.000034 | 0.048000    | 0.053000 | 0.050000 | 
| data_wide/valid   | 0.007300    | 0.005500 | 0.002300 | 6.237600    | 6.146500   | 6.151000   | 1.446000    | 0.036000 | 0.069000 | 0.017186    | 0.001099 | 0.005665 | 0.167000    | 0.088000 | 0.126000 | 
| data_wide/wide    | 0.006800    | 0.002100 | 0.024200 | 6.176600    | 6.157900   | 6.326100   | 0.570000    | 0.039000 | 0.070000 | 0.008363    | 0.005818 | 0.005592 | 0.071000    | 0.160000 | 0.159000 | 
| data_wide/invalid | 0.000085    | 0.000110 | 0.000150 | 6.288100    | 6.152100   | 6.130400   | 0.044000    | 0.040000 | 0.062000 | 0.000013    | 0.000040 | 0.000013 | 0.155000    | 0.156000 | 0.164000 | 
| data_huge/valid   | 0.009107    | 0.007655 | 0.012858 | 155.973852  | 146.537759 | 140.175232 | 1.401000    | 0.013300 | 0.026000 | 0.036806    | 0.003798 | 0.003751 | 0.069000    | 0.066000 | 0.072000 | 
| data_huge/wide    | 0.009418    | 0.013718 | 0.014266 | 157.189685  | 148.543529 | 147.952587 | 1.078000    | 0.011700 | 0.026000 | 0.018393    | 0.000805 | 0.003329 | 0.072000    | 0.081000 | 0.077000 | 
| data_huge/invalid | 0.000070    | 0.000095 | 0.000081 | 144.730700  | 158.009000 | 165.682000 | 0.012000    | 0.013000 | 0.023000 | 0.000012    | 0.000031 | 0.000013 | 0.054000    | 0.071000 | 0.081000 | 
| Total             | 30.98758568 |          |          | 15.44868897 |            |            | 21.95727007 |          |          | 39.09842031 |          |          | 21.48545355 |          |          | 
